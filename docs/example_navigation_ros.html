<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Navigation of ground vehicle · OpEn</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Code generation for ROS package for autonomous vehicle"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Navigation of ground vehicle · OpEn"/><meta property="og:type" content="website"/><meta property="og:url" content="https://alphaville.github.io/optimization-engine/"/><meta property="og:description" content="Code generation for ROS package for autonomous vehicle"/><meta property="og:image" content="https://alphaville.github.io/optimization-engine/img/docusaurus2.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://alphaville.github.io/optimization-engine/img/docusaurus.png"/><link rel="shortcut icon" href="/optimization-engine/img/box.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://alphaville.github.io/optimization-engine/blog/atom.xml" title="OpEn Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://alphaville.github.io/optimization-engine/blog/feed.xml" title="OpEn Blog RSS Feed"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/optimization-engine/js/scrollSpy.js"></script><link rel="stylesheet" href="/optimization-engine/css/main.css"/><script src="/optimization-engine/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/optimization-engine/"><img class="logo" src="/optimization-engine/img/box.png" alt="OpEn"/><h2 class="headerTitleWithLogo">OpEn</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/optimization-engine/docs/open-intro" target="_self">Docs</a></li><li class=""><a href="/optimization-engine/blog/" target="_self">Blog</a></li><li class=""><a href="https://docs.rs/optimization_engine/*/optimization_engine/" target="_self">API</a></li><li class=""><a href="/optimization-engine/blog/2019/03/06/talk-to-us" target="_self">Chat</a></li><li class=""><a href="https://www.github.com/alphaville/optimization-engine" target="_self">Github</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Navigation of ground vehicle</h1></header><article><div><span><h1><a class="anchor" aria-hidden="true" id="auto-generated-ground-vehicle-navigation-for-ros"></a><a href="#auto-generated-ground-vehicle-navigation-for-ros" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Auto-generated ground vehicle navigation for ROS</h1>
<h2><a class="anchor" aria-hidden="true" id="code-generation"></a><a href="#code-generation" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Code generation</h2>
<p>To generate a ROS package you can use opengen - OpEn's Python interface (with opengen version <code>0.5.0</code> or newer). You will have to provide certain configuration parameters, such as the package name, the node name and the rate of your node in Hz.</p>
<h3><a class="anchor" aria-hidden="true" id="install-opengen-050-in-a-virtual-environment"></a><a href="#install-opengen-050-in-a-virtual-environment" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Install opengen 0.5.0 in a virtual environment</h3>
<pre><code class="hljs"><span class="hljs-attr">cd</span> <span class="hljs-string">~</span>
<span class="hljs-attr">mkdir</span> <span class="hljs-string">open_ros_codegen</span>
<span class="hljs-attr">virtualenv</span> <span class="hljs-string">-p python3.6 venvopen</span>
<span class="hljs-attr">source</span> <span class="hljs-string">venvopen/bin/activate</span>
<span class="hljs-attr">pip</span> <span class="hljs-string">install opengen==0.5.0a1</span>
<span class="hljs-attr">pip</span> <span class="hljs-string">install matplotlib</span>
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="run-the-example-code-generation-program"></a><a href="#run-the-example-code-generation-program" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Run the example code generation program</h3>
<pre><code class="hljs"><span class="hljs-built_in">cd</span> ~/open_ros_codegen
<span class="hljs-built_in">mkdir</span> nmpc_open
<span class="hljs-built_in">cd</span> nmpc_open
</code></pre>
<p>Create a file named <code>create_open_solver.py</code> inside the <code>nmpc_open</code> folder with the following content</p>
<pre><code class="hljs"><span class="hljs-attr">import</span> <span class="hljs-string">casadi as cs</span>
<span class="hljs-attr">import</span> <span class="hljs-string">opengen as og</span>
<span class="hljs-attr">import</span> <span class="hljs-string">matplotlib.pyplot as plt</span>
<span class="hljs-attr">import</span> <span class="hljs-string">numpy as np</span>

<span class="hljs-attr">useSX</span> = <span class="hljs-string">True  # Use CasADi SX or MX. Seems quicker with SX</span>
<span class="hljs-attr">doSim</span> = <span class="hljs-string">False  # Run simulation after creating the solver</span>

<span class="hljs-attr">N</span> = <span class="hljs-string">10</span>
<span class="hljs-attr">NX</span> = <span class="hljs-string">3</span>
<span class="hljs-attr">NU</span> = <span class="hljs-string">2</span>
<span class="hljs-attr">sampling_time</span> = <span class="hljs-string">0.1</span>
<span class="hljs-attr">NSim</span> = <span class="hljs-string">100</span>

<span class="hljs-attr">Q</span> = <span class="hljs-string">cs.DM.eye(NX) * [1.0, 1.0, 0.0001]</span>
<span class="hljs-attr">R</span> = <span class="hljs-string">cs.DM.eye(NU) * [0.1, 50.0]</span>
<span class="hljs-attr">QN</span> = <span class="hljs-string">cs.DM.eye(NX) * [10.0, 10.0, 0.0001]</span>


<span class="hljs-attr">def</span> <span class="hljs-string">dynamics_ct(_x, _u):</span>
    <span class="hljs-attr">return</span> <span class="hljs-string">cs.vcat([_u[0] * cs.cos(_x[2]),</span>
                    <span class="hljs-meta">_u[0]</span> <span class="hljs-string">* cs.sin(_x[2]),</span>
                    <span class="hljs-attr">_u[1]])</span>


<span class="hljs-attr">def</span> <span class="hljs-string">dynamics_dt(x, u):</span>
    <span class="hljs-attr">dx</span> = <span class="hljs-string">dynamics_ct(x, u)</span>
    <span class="hljs-attr">return</span> <span class="hljs-string">cs.vcat([x[i] + sampling_time * dx[i] for i in range(NX)])</span>


<span class="hljs-attr">def</span> <span class="hljs-string">stage_cost(_x, _u, _x_ref=None, _u_ref=None):</span>
    <span class="hljs-attr">if</span> <span class="hljs-string">_x_ref is None:</span>
        <span class="hljs-attr">_x_ref</span> = <span class="hljs-string">cs.DM.zeros(_x.shape)</span>
    <span class="hljs-attr">if</span> <span class="hljs-string">_u_ref is None:</span>
        <span class="hljs-attr">_u_ref</span> = <span class="hljs-string">cs.DM.zeros(_u.shape)</span>
    <span class="hljs-attr">dx</span> = <span class="hljs-string">_x - _x_ref</span>
    <span class="hljs-attr">du</span> = <span class="hljs-string">_u - _u_ref</span>
    <span class="hljs-attr">return</span> <span class="hljs-string">cs.mtimes([dx.T, Q, dx]) + cs.mtimes([du.T, R, du])</span>


<span class="hljs-attr">def</span> <span class="hljs-string">terminal_cost(_x, _x_ref=None):</span>
    <span class="hljs-attr">if</span> <span class="hljs-string">_x_ref is None:</span>
        <span class="hljs-attr">_x_ref</span> = <span class="hljs-string">cs.DM.zeros(_x.shape)</span>
    <span class="hljs-attr">dx</span> = <span class="hljs-string">_x - _x_ref</span>
    <span class="hljs-attr">return</span> <span class="hljs-string">cs.mtimes([dx.T, QN, dx])</span>

<span class="hljs-attr">if</span> <span class="hljs-string">useSX:</span>
    <span class="hljs-attr">x_0</span> = <span class="hljs-string">cs.SX.sym("x_0", NX)</span>
    <span class="hljs-attr">x_ref</span> = <span class="hljs-string">cs.SX.sym("x_ref", NX)</span>
    <span class="hljs-attr">u_k</span> = <span class="hljs-string">[cs.SX.sym('u_' + str(i), NU) for i in range(N)]</span>
<span class="hljs-comment">    # dynamics_dt = util.get_rk4(dynamics_ct, NX, NU, casaditype="SX", Delta=sampling_time)</span>
<span class="hljs-attr">else</span>:<span class="hljs-string"></span>
    <span class="hljs-attr">x_0</span> = <span class="hljs-string">cs.MX.sym("x_0", NX)</span>
    <span class="hljs-attr">x_ref</span> = <span class="hljs-string">cs.MX.sym("x_ref", NX)</span>
    <span class="hljs-attr">u_k</span> = <span class="hljs-string">[cs.MX.sym('u_' + str(i), NU) for i in range(N)]</span>
<span class="hljs-comment">    # dynamics_dt = util.get_rk4(dynamics_ct, NX, NU, casaditype="MX", Delta=sampling_time)</span>


<span class="hljs-attr">x_t</span> = <span class="hljs-string">x_0</span>
<span class="hljs-attr">total_cost</span> = <span class="hljs-string">0</span>

<span class="hljs-attr">for</span> <span class="hljs-string">t in range(0, N):</span>
    <span class="hljs-attr">total_cost</span> <span class="hljs-string">+= stage_cost(x_t, u_k[t], x_ref)  # update cost</span>
    <span class="hljs-attr">x_t</span> = <span class="hljs-string">dynamics_dt(x_t, u_k[t])  # update state</span>

<span class="hljs-attr">total_cost</span> <span class="hljs-string">+= terminal_cost(x_t, x_ref)  # terminal cost</span>

<span class="hljs-attr">optimization_variables</span> = <span class="hljs-string">[]</span>
<span class="hljs-attr">optimization_parameters</span> = <span class="hljs-string">[]</span>

<span class="hljs-attr">optimization_variables</span> <span class="hljs-string">+= u_k</span>
<span class="hljs-attr">optimization_parameters</span> <span class="hljs-string">+= [x_0]</span>
<span class="hljs-attr">optimization_parameters</span> <span class="hljs-string">+= [x_ref]</span>

<span class="hljs-attr">optimization_variables</span> = <span class="hljs-string">cs.vertcat(*optimization_variables)</span>
<span class="hljs-attr">optimization_parameters</span> = <span class="hljs-string">cs.vertcat(*optimization_parameters)</span>

<span class="hljs-attr">umin</span> = <span class="hljs-string">[-2.0, -1.0] * N  # - cs.DM.ones(NU * N) * cs.inf</span>
<span class="hljs-attr">umax</span> = <span class="hljs-string">[2.0, 1.0] * N  # cs.DM.ones(NU * N) * cs.inf</span>

<span class="hljs-attr">bounds</span> = <span class="hljs-string">og.constraints.Rectangle(umin, umax)</span>

<span class="hljs-attr">problem</span> = <span class="hljs-string">og.builder.Problem(optimization_variables, optimization_parameters, total_cost).with_constraints(bounds)</span>

<span class="hljs-attr">if</span> <span class="hljs-string">doSim:</span>
    <span class="hljs-attr">build_config</span> = <span class="hljs-string">og.config.BuildConfiguration()\
        .with_build_directory("optimization_engine")\
        .with_build_mode("release")\
        .with_tcp_interface_config()</span>
<span class="hljs-attr">else</span>:<span class="hljs-string"></span>
    <span class="hljs-attr">ros_config</span> = <span class="hljs-string">og.config.RosConfiguration() \
        .with_package_name("open_nmpc_controller") \
        .with_node_name("open_mpc_controller_node") \
        .with_rate(10) \
        .with_description("Cool ROS node.")</span>
    <span class="hljs-attr">build_config</span> = <span class="hljs-string">og.config.BuildConfiguration()\
        .with_build_directory("optimization_engine")\
        .with_build_mode("release")\
        .with_build_c_bindings() \
        .with_ros(ros_config)</span>

<span class="hljs-attr">meta</span> = <span class="hljs-string">og.config.OptimizerMeta()\
    .with_optimizer_name("mpc_controller")</span>
<span class="hljs-attr">solver_config</span> = <span class="hljs-string">og.config.SolverConfiguration()\
    .with_tolerance(1e-5)</span>
<span class="hljs-attr">builder</span> = <span class="hljs-string">og.builder.OpEnOptimizerBuilder(problem,</span>
                                          <span class="hljs-attr">meta,</span>
                                          <span class="hljs-attr">build_config,</span>
                                          <span class="hljs-meta">solver_config)</span> <span class="hljs-string">\
    .with_verbosity_level(1)</span>
<span class="hljs-attr">builder.build()</span>


<span class="hljs-attr">if</span> <span class="hljs-string">doSim:</span>
<span class="hljs-comment">    # Use TCP server</span>
<span class="hljs-comment">    # ------------------------------------</span>
    <span class="hljs-attr">mng</span> = <span class="hljs-string">og.tcp.OptimizerTcpManager('optimization_engine/mpc_controller')</span>
    <span class="hljs-attr">mng.start()</span>

    <span class="hljs-attr">current_x_0</span> = <span class="hljs-string">[-1, -1, 0]</span>
    <span class="hljs-attr">current_x_ref</span> = <span class="hljs-string">[2, 2, 0]</span>
    <span class="hljs-attr">current_u</span> = <span class="hljs-string">[0, 0]</span>
    <span class="hljs-attr">cur_opt_var</span> = <span class="hljs-string">[0] * (N * NU)  # current optimization variables</span>
    <span class="hljs-attr">cur_opt_par</span> = <span class="hljs-string">current_x_0 + current_x_ref  # current optimization parameters</span>
    <span class="hljs-attr">average_solvetime</span> = <span class="hljs-string">0.0</span>

    <span class="hljs-attr">x_sim</span> = <span class="hljs-string">np.zeros((NSim + 1, NX))</span>
    <span class="hljs-meta">x_sim[0</span>:<span class="hljs-string">N + 1] = current_x_0</span>

    <span class="hljs-attr">for</span> <span class="hljs-string">k in range(0, NSim):</span>

        <span class="hljs-attr">solver_status</span> = <span class="hljs-string">mng.call(cur_opt_par)</span>
        <span class="hljs-attr">cur_opt_var</span> = <span class="hljs-string">solver_status['solution']</span>
        <span class="hljs-attr">solvetime</span> = <span class="hljs-string">solver_status['solve_time_ms']</span>
        <span class="hljs-attr">current_u</span> = <span class="hljs-string">cur_opt_var[0:NU]</span>
        <span class="hljs-attr">current_x_0</span> = <span class="hljs-string">dynamics_dt(current_x_0, current_u).toarray().flatten()</span>
        <span class="hljs-meta">x_sim[k</span> <span class="hljs-string">+ 1] = current_x_0</span>

        <span class="hljs-meta">print(("Step</span> <span class="hljs-string">%d/%d took %f [ms]") % (k, NSim, solvetime))</span>
        <span class="hljs-attr">average_solvetime</span> <span class="hljs-string">+= solvetime</span>

        <span class="hljs-attr">cur_opt_par</span> = <span class="hljs-string">list(current_x_0) + current_x_ref</span>

    <span class="hljs-attr">mng.kill()</span>

    <span class="hljs-meta">print(("Average</span> <span class="hljs-string">solvetime %.4f [ms]") % (average_solvetime/NSim))</span>

    <span class="hljs-attr">plt.figure()</span>
    <span class="hljs-attr">plt.subplot(3,1,1)</span>
    <span class="hljs-meta">plt.plot(x_sim[</span>:<span class="hljs-string">, 0])</span>
    <span class="hljs-meta">plt.subplot(3,</span> <span class="hljs-string">1, 2)</span>
    <span class="hljs-meta">plt.plot(x_sim[</span>:<span class="hljs-string">, 1])</span>
    <span class="hljs-meta">plt.subplot(3,</span> <span class="hljs-string">1, 3)</span>
    <span class="hljs-meta">plt.plot(x_sim[</span>:<span class="hljs-string">, 0], x_sim[:, 1])</span>
    <span class="hljs-attr">plt.show()</span>
</code></pre>
<p>The above program will generate a parametric optimizer at <code>optimization_engine/mpc_controller</code>. The ROS package will be in <code>optimization_engine/mpc_controller/open_nmpc_controller</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="create-a-ros-workspace-for-our-new-package"></a><a href="#create-a-ros-workspace-for-our-new-package" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create a ROS workspace for our new package</h2>
<p>We must create a ROS catkin workspace and place our package inside the <code>src</code> folder. We will do this by creating a symbolic link. After that, we can build and test our package.</p>
<pre><code class="hljs"><span class="hljs-attr">cd</span> <span class="hljs-string">~/open_nmpc_controller/</span>
<span class="hljs-attr">mkdir</span> <span class="hljs-string">-p catkin_ws/src</span>
<span class="hljs-attr">cd</span> <span class="hljs-string">catkin_ws/src</span>
<span class="hljs-attr">ln</span> <span class="hljs-string">-s ../../nmpc_open/optimization_engine/mpc_controller/open_nmpc_controller .</span>
<span class="hljs-attr">cd</span> <span class="hljs-string">~/open_ros_codegen/catkin_ws</span>
<span class="hljs-attr">catkin</span> <span class="hljs-string">build</span>
<span class="hljs-attr">source</span> <span class="hljs-string">devel/setup.bash</span>
<span class="hljs-attr">roslaunch</span> <span class="hljs-string">open_nmpc_controller open_optimizer.launch</span>
</code></pre>
<p>Right now we have a running ROS node with the defualt configuration. Now we must eidt it a little bit to drive our vehicle.</p>
<h2><a class="anchor" aria-hidden="true" id="download-and-run-husky-packages"></a><a href="#download-and-run-husky-packages" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Download and run Husky packages</h2>
<pre><code class="hljs">cd ~/open_nmpc_controller/catkin_ws/src
git <span class="hljs-keyword">clone</span> <span class="hljs-title">https</span>://github.com/husky/husky.git
catkin build
</code></pre>
<p>Now we can run the Husky simulation as follows</p>
<p><code>roslaunch husky_gazebo husky_empty_world.launch</code></p>
<h2><a class="anchor" aria-hidden="true" id="edit-the-auto-generated-node"></a><a href="#edit-the-auto-generated-node" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Edit the auto-generated node</h2>
<p>Our node should know where the vehicle is in order to obtain the correct control commands, so we must listen to an Odometry topic that is being published to <code>/odometry/filtered</code></p>
<p>Given our current position and orientation, we will obtain the NMPC solution and publish it as a Twist message to the <code>/husky_velocity_controller/cmd_vel</code> topic.</p>
<p>In order to do that, we must modify the auto generated <code>open_optimizer.cpp</code> file as follows:</p>
<pre><code class="hljs"><span class="hljs-comment">/**
 * This is an auto-generated file by Optimization Engine (OpEn)
 * OpEn is a free open-source software - see doc.optimization-engine.xyz
 * dually licensed under the MIT and Apache v2 licences.
 *
 * Generated at 2020-05-07 01:22:27.483106.
 */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"ros/ros.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"open_nmpc_controller/OptimizationResult.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"open_nmpc_controller/OptimizationParameters.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"mpc_controller_bindings.hpp"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"open_optimizer.hpp"</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;geometry_msgs/Twist.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;nav_msgs/Odometry.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"tf/transform_datatypes.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"tf/LinearMath/Matrix3x3.h"</span></span>


<span class="hljs-keyword">namespace</span> open_nmpc_controller {
<span class="hljs-comment">/**
 * Class open_nmpc_controller::OptimizationEngineManager manages the
 * exchange of data between the input and output topics
 * of this node
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OptimizationEngineManager</span> {</span>

<span class="hljs-keyword">private</span>:
    open_nmpc_controller::OptimizationParameters params;
    open_nmpc_controller::OptimizationResult results;
    <span class="hljs-keyword">double</span> p[MPC_CONTROLLER_NUM_PARAMETERS] = { <span class="hljs-number">0</span> };
    <span class="hljs-keyword">double</span> u[MPC_CONTROLLER_NUM_DECISION_VARIABLES] = { <span class="hljs-number">0</span> };
    <span class="hljs-keyword">double</span> *y = <span class="hljs-literal">NULL</span>;

    <span class="hljs-keyword">double</span> current_pos[<span class="hljs-number">3</span>] = {<span class="hljs-number">0</span>};
    <span class="hljs-keyword">double</span> current_ref[<span class="hljs-number">3</span>] = {<span class="hljs-number">0</span>};

    mpc_controllerCache* cache;
    <span class="hljs-keyword">double</span> init_penalty = ROS_NODE_MPC_CONTROLLER_DEFAULT_INITIAL_PENALTY;

    <span class="hljs-comment">/**
     * Publish obtained results to output topic
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">publishToTopic</span><span class="hljs-params">(ros::Publisher&amp; publisher)</span>
    </span>{
        publisher.publish(results);
    }

    <span class="hljs-comment">/**
     * Updates the input data based on the data that are posted
     * on /mpc/open_parameters (copies value from topic data to
     * local variables). This method is responsible for parsing
     * the data announced on the input topic.
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">updateInputData</span><span class="hljs-params">()</span>
    </span>{
        init_penalty = (params.initial_penalty &gt; <span class="hljs-number">1.0</span>)
            ? params.initial_penalty
            : ROS_NODE_MPC_CONTROLLER_DEFAULT_INITIAL_PENALTY;

        <span class="hljs-keyword">if</span> (params.parameter.<span class="hljs-built_in">size</span>() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; MPC_CONTROLLER_NUM_PARAMETERS; ++i)
                p[i] = params.parameter[i];
        }

        <span class="hljs-keyword">if</span> (params.initial_guess.<span class="hljs-built_in">size</span>() == MPC_CONTROLLER_NUM_DECISION_VARIABLES) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; MPC_CONTROLLER_NUM_DECISION_VARIABLES; ++i)
                u[i] = params.initial_guess[i];
        }

        <span class="hljs-keyword">if</span> (params.initial_y.<span class="hljs-built_in">size</span>() == MPC_CONTROLLER_N1) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; MPC_CONTROLLER_N1; ++i)
                y[i] = params.initial_y[i];
        }

    }

    <span class="hljs-comment">/**
     * Call OpEn to solve the problem
     */</span>
    <span class="hljs-function">mpc_controllerSolverStatus <span class="hljs-title">solve</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> mpc_controller_solve(cache, u, p, y, &amp;init_penalty);
    }


<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">/**
     * Constructor of OptimizationEngineManager
     */</span>
    OptimizationEngineManager()
    {
        y = <span class="hljs-keyword">new</span> <span class="hljs-keyword">double</span>[MPC_CONTROLLER_N1];
        cache = mpc_controller_new();
    }

    <span class="hljs-comment">/**
     * Destructor of OptimizationEngineManager
     */</span>
    ~OptimizationEngineManager()
    {
        <span class="hljs-keyword">if</span> (y!=<span class="hljs-literal">NULL</span>) <span class="hljs-keyword">delete</span>[] y;
        mpc_controller_free(cache);
    }

    <span class="hljs-comment">/**
     * Copies results from `status` to the local field `results`
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">updateResults</span><span class="hljs-params">(mpc_controllerSolverStatus&amp; status)</span>
    </span>{
        <span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">double</span>&gt; <span class="hljs-title">sol</span><span class="hljs-params">(u, u + MPC_CONTROLLER_NUM_DECISION_VARIABLES)</span></span>;
        results.solution = sol;
        <span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">double</span>&gt; <span class="hljs-title">y</span><span class="hljs-params">(status.lagrange, status.lagrange + MPC_CONTROLLER_N1)</span></span>;
        results.lagrange_multipliers = y;
        results.inner_iterations = status.num_inner_iterations;
        results.outer_iterations = status.num_outer_iterations;
        results.norm_fpr = status.last_problem_norm_fpr;
        results.penalty = status.penalty;
        results.status = (<span class="hljs-keyword">int</span>)status.exit_status;
        results.solve_time_ms = (<span class="hljs-keyword">double</span>)status.solve_time_ns / <span class="hljs-number">1000000.0</span>;
        results.infeasibility_f2 = status.f2_norm;
        results.infeasibility_f1 = status.delta_y_norm_over_c;
    }

    <span class="hljs-comment">/**
     * Callback that obtains data from topic `/open_nmpc_controller/open_params`
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mpcReceiveRequestCallback</span><span class="hljs-params">(
        <span class="hljs-keyword">const</span> open_nmpc_controller::OptimizationParameters::ConstPtr&amp; msg)</span>
    </span>{
        params = *msg;
    }

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">solveAndPublish</span><span class="hljs-params">(ros::Publisher&amp; publisher)</span>
    </span>{
        updateInputData(); <span class="hljs-comment">/* get input data */</span>
        mpc_controllerSolverStatus status = solve(); <span class="hljs-comment">/* solve!  */</span>
        updateResults(status); <span class="hljs-comment">/* pack results into `results` */</span>
        publishToTopic(publisher);
    }

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">CommandPoseCallback</span><span class="hljs-params">(<span class="hljs-keyword">const</span> geometry_msgs::PoseStampedConstPtr&amp; msg)</span>
    </span>{
        current_ref[<span class="hljs-number">0</span>] = msg-&gt;pose.<span class="hljs-built_in">position</span>.x;
        current_ref[<span class="hljs-number">1</span>] = msg-&gt;pose.<span class="hljs-built_in">position</span>.y;
        current_ref[<span class="hljs-number">2</span>] = msg-&gt;pose.orientation.w;  <span class="hljs-comment">// we will use this field for the yaw in degrees.</span>
    }

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">odometryCallback</span><span class="hljs-params">(<span class="hljs-keyword">const</span> nav_msgs::Odometry::ConstPtr &amp;msg)</span> </span>{
        <span class="hljs-keyword">double</span> roll, pitch, yaw;

        <span class="hljs-function">tf::Quaternion <span class="hljs-title">quat</span><span class="hljs-params">(msg-&gt;pose.pose.orientation.x, msg-&gt;pose.pose.orientation.y, msg-&gt;pose.pose.orientation.z, msg-&gt;pose.pose.orientation.w)</span></span>;
        tf::Matrix3x3(quat).getRPY(roll, pitch, yaw);

        current_pos[<span class="hljs-number">0</span>] = msg-&gt;pose.pose.<span class="hljs-built_in">position</span>.x;
        current_pos[<span class="hljs-number">1</span>] = msg-&gt;pose.pose.<span class="hljs-built_in">position</span>.y;
        current_pos[<span class="hljs-number">2</span>] = yaw;
    }

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">solveAndPublishCmdVel</span><span class="hljs-params">(ros::Publisher&amp; publisher)</span>
    </span>{
        <span class="hljs-keyword">double</span> current_par [MPC_CONTROLLER_NUM_PARAMETERS] = {<span class="hljs-number">0</span>};
        <span class="hljs-keyword">double</span> current_var [MPC_CONTROLLER_NUM_DECISION_VARIABLES] = {<span class="hljs-number">0</span>};
        <span class="hljs-keyword">double</span> lin_vel_cmd, ang_vel_cmd = <span class="hljs-number">0</span>;

        current_par[<span class="hljs-number">0</span>] = current_pos[<span class="hljs-number">0</span>];
        current_par[<span class="hljs-number">1</span>] = current_pos[<span class="hljs-number">1</span>];
        current_par[<span class="hljs-number">2</span>] = current_pos[<span class="hljs-number">2</span>];
        current_par[<span class="hljs-number">3</span>] = current_ref[<span class="hljs-number">0</span>];
        current_par[<span class="hljs-number">4</span>] = current_ref[<span class="hljs-number">1</span>];
        current_par[<span class="hljs-number">5</span>] = current_ref[<span class="hljs-number">2</span>];

        <span class="hljs-comment">/* solve                  */</span>
        mpc_controllerSolverStatus status = mpc_controller_solve(cache, current_var, current_par, <span class="hljs-number">0</span>, &amp;init_penalty);

        lin_vel_cmd = current_var[<span class="hljs-number">0</span>];
        ang_vel_cmd = current_var[<span class="hljs-number">1</span>];

        geometry_msgs::Twist twist;
        twist.linear.x = lin_vel_cmd;
        twist.linear.y = <span class="hljs-number">0.0</span>;
        twist.linear.z = <span class="hljs-number">0.0</span>;
        twist.angular.x = <span class="hljs-number">0.0</span>;
        twist.angular.y = <span class="hljs-number">0.0</span>;
        twist.angular.z = ang_vel_cmd;
        publisher.publish(twist);

        ROS_INFO(<span class="hljs-string">"x: %f, y: %f, yaw: %f"</span>, current_pos[<span class="hljs-number">0</span>], current_pos[<span class="hljs-number">1</span>], current_pos[<span class="hljs-number">2</span>]);
        ROS_INFO(<span class="hljs-string">"Solve time: %f ms. I will send %f %f \n"</span>, (<span class="hljs-keyword">double</span>)status.solve_time_ns / <span class="hljs-number">1000000.0</span>, lin_vel_cmd, ang_vel_cmd);

    }

}; <span class="hljs-comment">/* end of class OptimizationEngineManager */</span>

} <span class="hljs-comment">/* end of namespace open_nmpc_controller */</span>

<span class="hljs-comment">/**
 * Main method
 *
 * This advertises a new (private) topic to which the optimizer
 * announces its solution and solution status and details. The
 * publisher topic is 'open_nmpc_controller/result'.
 *
 * It obtains inputs from 'open_nmpc_controller/parameters'.
 *
 */</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>** argv)</span>
</span>{

    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> result_topic, params_topic;  <span class="hljs-comment">/* parameter and result topics */</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> out_twist, in_odometry;
    <span class="hljs-keyword">double</span> rate; <span class="hljs-comment">/* rate of node (specified by parameter) */</span>

    open_nmpc_controller::OptimizationEngineManager mng;
    ros::init(argc, argv, ROS_NODE_MPC_CONTROLLER_NODE_NAME);
    <span class="hljs-function">ros::NodeHandle <span class="hljs-title">private_nh</span><span class="hljs-params">(<span class="hljs-string">"~"</span>)</span></span>;

    <span class="hljs-comment">/* obtain parameters from config/open_params.yaml file */</span>
    private_nh.param(<span class="hljs-string">"result_topic"</span>, result_topic,
                     <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(ROS_NODE_MPC_CONTROLLER_RESULT_TOPIC));
    private_nh.param(<span class="hljs-string">"params_topic"</span>, params_topic,
                     <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(ROS_NODE_MPC_CONTROLLER_PARAMS_TOPIC));
    private_nh.param(<span class="hljs-string">"rate"</span>, rate,
                     <span class="hljs-keyword">double</span>(ROS_NODE_MPC_CONTROLLER_RATE));

    private_nh.param(<span class="hljs-string">"out_twist_name"</span>, out_twist, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(<span class="hljs-string">"/husky_velocity_controller/cmd_vel"</span>));
    private_nh.param(<span class="hljs-string">"in_odom_name"</span>, in_odometry, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(<span class="hljs-string">"/odometry/filtered"</span>));

    ros::Publisher mpc_pub
        = private_nh.advertise&lt;open_nmpc_controller::OptimizationResult&gt;(
            ROS_NODE_MPC_CONTROLLER_RESULT_TOPIC,
            ROS_NODE_MPC_CONTROLLER_RESULT_TOPIC_QUEUE_SIZE);
    ros::Subscriber sub
        = private_nh.subscribe(
            ROS_NODE_MPC_CONTROLLER_PARAMS_TOPIC,
            ROS_NODE_MPC_CONTROLLER_PARAMS_TOPIC_QUEUE_SIZE,
            &amp;open_nmpc_controller::OptimizationEngineManager::mpcReceiveRequestCallback,
            &amp;mng);

    ros::Subscriber pos_sub
        = private_nh.subscribe(in_odometry, <span class="hljs-number">1</span>, &amp;open_nmpc_controller::OptimizationEngineManager::odometryCallback, &amp;mng);
    <span class="hljs-function">ros::Rate <span class="hljs-title">loop_rate</span><span class="hljs-params">(ROS_NODE_MPC_CONTROLLER_RATE)</span></span>;
    ros::Subscriber command_trajectory_subscriber
        = private_nh.subscribe(<span class="hljs-string">"command/pose"</span>, <span class="hljs-number">1</span>, &amp;open_nmpc_controller::OptimizationEngineManager::CommandPoseCallback, &amp;mng);
    ros::Publisher pub_twist_cmd = private_nh.advertise&lt;geometry_msgs::Twist&gt;(out_twist, <span class="hljs-number">1</span>);

    <span class="hljs-keyword">while</span> (ros::ok()) {
        <span class="hljs-comment">// mng.solveAndPublish(mpc_pub);</span>
        mng.solveAndPublishCmdVel(pub_twist_cmd);
        ros::spinOnce();
        loop_rate.sleep();
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>We can rebuild and launch our node.</p>
<pre><code class="hljs"><span class="hljs-attr">cd</span> <span class="hljs-string">~/open_nmpc_controller/catkin_ws/</span>
<span class="hljs-attr">catkin</span> <span class="hljs-string">build</span>
<span class="hljs-attr">roslaunch</span> <span class="hljs-string">open_nmpc_controller open_optimizer.launch</span>
</code></pre>
<p>Our modified node will listen to the topic <code>/open_nmpc_controller/command/pose</code> and set the reference. As an example, you can execute</p>
<pre><code class="hljs"><span class="hljs-attr">rostopic</span> <span class="hljs-string">pub /open_nmpc_controller/command/pose geometry_msgs/PoseStamped "header:</span>
  <span class="hljs-attr">seq</span>: <span class="hljs-string">0</span>
  <span class="hljs-attr">stamp</span>:<span class="hljs-string"></span>
    <span class="hljs-attr">secs</span>: <span class="hljs-string">0</span>
    <span class="hljs-attr">nsecs</span>: <span class="hljs-string">0</span>
  <span class="hljs-attr">frame_id</span>: <span class="hljs-string">''</span>
<span class="hljs-attr">pose</span>:<span class="hljs-string"></span>
  <span class="hljs-attr">position</span>:<span class="hljs-string"></span>
    <span class="hljs-attr">x</span>: <span class="hljs-string">10.0</span>
    <span class="hljs-attr">y</span>: <span class="hljs-string">10.0</span>
    <span class="hljs-attr">z</span>: <span class="hljs-string">0.0</span>
  <span class="hljs-attr">orientation</span>:<span class="hljs-string"></span>
    <span class="hljs-attr">x</span>: <span class="hljs-string">0.0</span>
    <span class="hljs-attr">y</span>: <span class="hljs-string">0.0</span>
    <span class="hljs-attr">z</span>: <span class="hljs-string">0.0</span>
    <span class="hljs-attr">w</span>: <span class="hljs-string">0.0"</span>
</code></pre>
<p>To send the ground vehicle to the point (10, 10).</p>
</span></div></article></div><div class="docs-prevnext"></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#code-generation">Code generation</a><ul class="toc-headings"><li><a href="#install-opengen-050-in-a-virtual-environment">Install opengen 0.5.0 in a virtual environment</a></li><li><a href="#run-the-example-code-generation-program">Run the example code generation program</a></li></ul></li><li><a href="#create-a-ros-workspace-for-our-new-package">Create a ROS workspace for our new package</a></li><li><a href="#download-and-run-husky-packages">Download and run Husky packages</a></li><li><a href="#edit-the-auto-generated-node">Edit the auto-generated node</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/optimization-engine/" class="nav-home"><img src="/optimization-engine/img/box.png" alt="OpEn" width="66" height="58"/></a><div><h5>Docs</h5><a href="/optimization-engine/docs/open-intro.html">Getting Started</a><a href="/optimization-engine/docs/python-interface.html">Python interface</a><a href="/optimization-engine/docs/matlab-interface.html">MATLAB interface</a><a href="/optimization-engine/docs/docker">Docker</a></div><div><h5>Community</h5><a href="/optimization-engine/users.html">User Showcase</a><a href="https://discord.gg/mfYpn4V" target="_blank" rel="noreferrer noopener">Discord community</a><a href="https://gitter.im/alphaville/optimization-engine" target="_blank" rel="noreferrer noopener">Chat on Gitter</a><a href="/optimization-engine/docs/irc.html">Project Chat (Good Ol&#x27; IRC)</a><a href="https://twitter.com/isToxic" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="/optimization-engine/blog">Blog</a><a href="https://github.com/alphaville/optimization-engine" target="_blank">GitHub</a><a href="https://www.openhub.net/p/optimization-engine" target="_blank">Openhub</a><a class="github-button" href="https://github.com/alphaville/optimization-engine" data-icon="octicon-star" data-count-href="/alphaville/optimization-engine/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><br/><br/><a href="https://twitter.com/share?ref_src=twsrc%5Etfw&amp;via=isToxic" class="twitter-share-button" data-show-count="false" data-text="Fast and accurate embedded nonconvex optimization with #OptimizationEngine">Tweet</a><script async="" src="https://platform.twitter.com/widgets.js" charSet="utf-8"></script></div></section><section class="copyright">Copyright © 2020 Pantelis Sopasakis and Emil Fresk</section><section class="copyright"><div>Box Icon made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div></section></footer></div></body></html>